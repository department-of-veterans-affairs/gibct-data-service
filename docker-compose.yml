# Compose stack to run gi-bill-data-service
version: '3.4'
services:
  postgres:
    command: postgres -c shared_preload_libraries=pg_stat_statements -c pg_stat_statements.track=all -c max_connections=200
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-password}"
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      PGDATA: /tmp
    image: postgis/postgis:14-3.3-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - 54321:5432

  gibct:
    build:
      context: .
      target: development
    image: "gibct:${DOCKER_IMAGE:-latest}"
    volumes:
      - .:/gi-bill-data-service/src/:cached
      - dev_bundle:/usr/local/bundle
      - ./tmp/Downloads:/mnt/downloads:/srv/gi-bill-data-service/Downloads
    working_dir: /gi-bill-data-service/src
    ports:
      - 4000:4000
    environment:
      DATABASE_CLEANER_ALLOW_REMOTE_DATABASE_URL: true
      DATABASE_URL: "postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${POSTGRES_DATABASE:-gibct-data-service_development}?pool=4"
      DATABASE_TEST_URL: "postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${POSTGRES_DATABASE:-gibct-data-service_test}?pool=4"
      POSTGRES_PORT: "${POSTGRES_PORT:-5432}"
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-password}"
      SECRET_KEY_BASE: 0ae77385a98d4d28886d792832fbbe036152efb4a112fae2d06261850a5b6728
      GOVDELIVERY_URL: 'stage-tms.govdelivery.com'
      GOVDELIVERY_TOKEN: 'abc123'
      GOVDELIVERY_STAGING_SERVICE: 'True'
      DEPLOYMENT_ENV: 'vagov-dev'
      # CI: 'true'
      LOCAL_USER: ${LOCAL_USER}
      LOCAL_PASS: ${LOCAL_PASS}
      STAGE_USER: ${STAGE_USER}
      STAGE_PASS: ${STAGE_PASS}
      PROD_USER: ${PROD_USER}
      PROD_PASS: ${PROD_PASS}
    depends_on:
      - postgres
    links:
      - postgres
    command: bash --login -c "bundle exec rails s -p 4000 -b 0.0.0.0"
    stdin_open: true
    tty: true
volumes:
  dev_bundle:
  postgres_data:
