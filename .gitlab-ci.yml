stages:
  - lint
  - test
  - build
  - deploy

variables:
  REGISTRY_IMAGE: "registry.gitlab.local:5050/noah/gibct-data-service"

lint:
  stage: lint
  tags:
    - shell
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
    DOCKER_IMAGE: "latest"
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin registry.gitlab.local:5050
  script:
    - docker compose -f docker-compose.test.yml build
    - docker compose -f docker-compose.test.yml run --rm gibct bash -c "bundle exec bundle-audit check --update"
    - docker compose -f docker-compose.test.yml run --rm gibct bash -c "bundle exec rubocop --parallel"
    - docker compose -f docker-compose.test.yml run --rm gibct bash -c "bundle exec brakeman --ensure-latest --confidence-level=3"
  after_script:
    - docker compose -f docker-compose.test.yml down || true

build-test-image:
  stage: test
  tags:
    - shell
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
    TEST_IMAGE: "registry.gitlab.local:5050/noah/gibct-data-service/test:${CI_COMMIT_SHA}"
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin registry.gitlab.local:5050
  script:
    - docker compose -f docker-compose.test.yml build
    - docker tag gibct:latest ${TEST_IMAGE}
    - docker push ${TEST_IMAGE}

test:
  stage: test
  needs: [build-test-image]
  tags:
    - shell
  variables:
    TEST_IMAGE: "registry.gitlab.local:5050/noah/gibct-data-service/test:${CI_COMMIT_SHA}"
    DOCKER_HOST: "unix:///var/run/docker.sock"
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin registry.gitlab.local:5050
  script:
    - docker pull ${TEST_IMAGE}
    - docker tag ${TEST_IMAGE} gibct:latest
    - docker compose -f docker-compose.test.yml down --remove-orphans || true
    - docker compose -f docker-compose.test.yml up -d postgres
    - sleep 10
    - docker compose -f docker-compose.test.yml run --rm gibct bash -c "bundle exec rails db:prepare"
    - docker compose -f docker-compose.test.yml run --rm gibct bash -c "bundle exec rspec"
  after_script:
    - docker compose -f docker-compose.test.yml down || true
  only:
    - branches

build:
  stage: build
  tags:
    - shell
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin registry.gitlab.local:5050
  script:
    - docker build --target k8s -t ${REGISTRY_IMAGE}:${CI_COMMIT_SHA} -t ${REGISTRY_IMAGE}:latest .
    - docker push ${REGISTRY_IMAGE}:${CI_COMMIT_SHA}
    - docker push ${REGISTRY_IMAGE}:latest
  only:
    - master

deploy:
  stage: deploy
  tags:
    - shell
  variables:
    INFRA_REPO: "git@gitlab.local:noah/va-infrastructure.git"
  before_script:
    - git config --global user.email "gitlab-runner@local"
    - git config --global user.name "GitLab Runner"
  script:
    - rm -rf /tmp/va-infrastructure
    - git clone ${INFRA_REPO} /tmp/va-infrastructure
    - cd /tmp/va-infrastructure
    - |
      sed -i "s|newTag:.*|newTag: ${CI_COMMIT_SHA}|" kubernetes/gibct/overlays/dev/kustomization.yaml
    - git add .
    - git commit -m "Deploy gibct ${CI_COMMIT_SHA}"
    - git push origin main
  after_script:
    - rm -rf /tmp/va-infrastructure
  only:
    - master
  environment:
    name: dev
    url: http://localhost:3001